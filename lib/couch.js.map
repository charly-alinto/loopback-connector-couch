{"version":3,"sources":["couch.js"],"names":[],"mappings":"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","file":"couch.js","sourcesContent":["var {_} = require('lodash');\nvar debug = require('debug')('loopback:connector:couch');\n\n// api\nexports.initialize = function(dataSource, callback) {\n\tvar connector = new CouchConnector(dataSource);\n\treturn callback && process.nextTick(callback);\n};\n\n//Constructor and useful reference functions\nclass CouchConnector {\n\tconstructor(dataSource) {\n\n\t\tvar ref;\n\t\tvar ref1;\n\t\tvar ref2;\n\t\tthis.relational = false;\n\t\tthis.dataSource = dataSource;\n\t\tdataSource.connector = this;\n\n\t\tvar settings = dataSource.settings || {};\n\t\tthis.settings = settings;\n\t\thelpers.optimizeSettings(settings);\n\n\t\tvar design = {views: {by_model: {map:\n\t\t\t'function (doc) { if (doc.loopbackModel) return emit(doc.loopbackModel, null); }'\n\t\t}\n\t\t}\n\t\t};\n\n\t\tif (((ref = settings.auth) != null) ? ref.reader : undefined) {\n\t\t\tthis._nanoReader = require('nano')(this.buildAuthUrl(settings.auth.reader));\n\t\t}\n\t\tif (((ref1 = settings.auth) != null) ? ref1.writer : undefined) {\n\t\t\tthis._nanoWriter = require('nano')(this.buildAuthUrl(settings.auth.writer));\n\t\t}\n\t\tif (((ref2 = settings.auth) != null) ? ref2.admin : undefined) {\n\t\t\tthis._nanoAdmin = require('nano')(this.buildAuthUrl(settings.auth.admin));\n\t\t}\n\n\t\tif (!this._nanoReader) { this._nanoReader = require('nano')(this.buildAuthUrl(settings.auth)); }\n\t\tif (!this._nanoWriter) { this._nanoWriter = require('nano')(this.buildAuthUrl(settings.auth)); }\n\t\tif (!this._nanoAdmin) { this._nanoAdmin = require('nano')(this.buildAuthUrl(settings.auth)); }\n\n\t\thelpers.updateDesign(this._nanoAdmin, '_design/loopback', design);\n\t\tthis._models = {};\n\t\tthis.name = 'couchdb';\n\t\tif (settings.views && _.isArray(settings.views)) {\n\t\t\tthis.DataAccessObject = function() {};\n\t\t\t//add existing methods\n\t\t\tif (dataSource.constructor.DataAccessObject) {\n\t\t\t\tfor (var k in dataSource.constructor.DataAccessObject) {\n\t\t\t\t\tvar v = dataSource.constructor.DataAccessObject[k];\n\t\t\t\t\tthis.DataAccessObject[k] = v;\n\t\t\t\t}\n\t\t\t\tfor (var k in dataSource.constructor.DataAccessObject.prototype) {\n\t\t\t\t\tv = dataSource.constructor.DataAccessObject.prototype[k];\n\t\t\t\t\tthis.DataAccessObject.prototype[k] = v;\n\t\t\t\t}\n\t\t\t}\n\t\t\t//then add connector method\n\t\t\tvar viewFn = this.buildViewEndpoint(settings.views);\n\t\t\tthis.DataAccessObject.queryView = viewFn;\n\t\t\tdataSource.queryView = viewFn;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tgetDefaultIdType() {\n\t\treturn String;\n\t}\n\n\tgetTypes() {\n\t\treturn ['db', 'nosql', 'couchdb'];\n\t}\n\n\tgetMetadata() {\n\t\tif (!this._metaData) {\n\t\t\tthis._metaData =\n\t\t\t\t{types: this.getTypes(),\n\t\t\t\tdefaultIdType: this.getDefaultIdType(),\n\t\t\t\tisRelational: this.relational,\n\t\t\t\tschemaForSettings: {}\n\t\t\t\t};\n\t\t}\n\t\treturn this._metaData;\n\t}\n\n\tdefine(descr) {\n\t\tvar modelName = descr.model.modelName;\n\n\t\tthis._models[modelName] = descr;\n\t\tdescr.properties._rev = {type: String};\n\t\t// Add index views for schemas that have indexes\n\t\tvar design =\n\t\t\t{views: {}}\n\t\t;var hasIndexes = false;\n\t\tfor (var propName in descr.properties) {\n\t\t\tvar value = descr.properties[propName];\n\t\t\tif (value.index) {\n\t\t\t\thasIndexes = true;\n\t\t\t\tvar viewName = helpers.viewName(propName);\n\t\t\t\tdesign.views[viewName] =\n\t\t\t\t\t{map: 'function (doc) { if (doc.loopbackModel === \\'' + modelName + '\\' && doc.'+propName + ') return emit(doc.' + propName + ', null); }'}\n\t\t\t}\n\t\t}\n\t\t;if (hasIndexes) {\n\t\t\tvar designName = '_design/' + helpers.designName(modelName);\n\t\t\treturn helpers.updateDesign(this._nanoAdmin, designName, design);\n\t\t}\n\t}\n\n//Loopback.io prototype functions\n\tcreate(model, data, callback) {\n\t\tdebug('CouchDB create');\n\t\treturn this.save(model, data, callback);\n\t}\n\n\tsave(model, data, callback) {\n\t\tdebug('CouchDB save');\n\t\tif (!data) { return callback && callback(\"Cannot create an empty document in the database\"); }\n\t\tdelete data._deleted; \t\t// Prevents accidental deletion via save command\n\t\treturn this._nanoWriter.insert(this.forDB(model, data), (err, rsp) => {\n\t\t\tif (err) { return callback(err); }\n\t\t\t// Undo the effects of savePrep as data object is the only one\n\t\t\t// that the Loopback.io can access.\n\t\t\thelpers.undoPrep(data);\n\t\t\t// Update the data object with the revision returned by CouchDb.\n\t\t\tdata._rev = rsp.rev;\n\t\t\treturn callback && callback(null, rsp.id, rsp.rev);\n\t\t});\n\t}\n\n\tupdateOrCreate(model, data, callback) {\n\t\tdebug('CouchDB updateOrCreate');\n\t\tdelete data._deleted;\t\t// Prevents accidental deletion\n\t\treturn this.save(model, data, function(err, id, rev) {\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\tdata.id = id;\n\t\t\tdata._rev = rev;\n\t\t\treturn callback && callback(null, data);\n\t\t});\n\t}\n\n\tupdate(model, where, data, callback) {\n\t\tdebug('CouchDB update');\n\t\tdelete data._deleted;\t\t// Prevents accidental deletion\n\t\treturn this.all(model, {where}, (err, docsFromDb) => {\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\thelpers.merge(docsFromDb, data);\n\t\t\tif (!_.isArray(docsFromDb)) {\n\t\t\t\tdocsFromDb = [docsFromDb];\n\t\t\t}\n\t\t\tvar docs = ((() => {\n\t\t\t\tvar result = [];\n\t\t\t\tfor (var i = 0, doc; i < docsFromDb.length; i++) {\n\t\t\t\t\tdoc = docsFromDb[i];\n\t\t\t\t\tresult.push(this.forDB(model, doc));\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t})());\n\t\t\tdebug(docs);\n\t\t\treturn this._nanoWriter.bulk({docs}, function(err, rsp) {\n\t\t\t\treturn callback && callback(err, rsp);\n\t\t\t});\n\t\t});\n\t}\n\n\tupdateAttributes(model, id, attributes, callback) {\n\t\tdebug('CouchDB updateAttributes');\n\t\tdelete attributes._deleted;\t//prevent accidental deletion\n\t\treturn this._nanoReader.get(id, (err, doc) => {\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\treturn this.save(model, helpers.merge(doc, attributes), function(err, rsp) {\n\t\t\t\tif (err) { return callback && callback(err); }\n\t\t\t\tdoc._rev = rsp.rev;\n\t\t\t\treturn callback && callback(null, doc);\n\t\t\t});\n\t\t});\n\t}\n\n\tdestroyAll(model, where, callback) {\n\t\tdebug('CouchDB destroyAll');\n\t\treturn this.all(model, {where}, (err, docs) => {\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\tdebug(docs);\n\t\t\tdocs = (() => {\n\t\t\t\tvar result = [];\n\t\t\t\tfor (var i = 0, doc; i < docs.length; i++) {\n\t\t\t\t\tdoc = docs[i];\n\t\t\t\t\tresult.push({_id: doc.id, _rev: doc._rev, _deleted: true});\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t})();\n\t\t\treturn this._nanoWriter.bulk({docs}, function(err, rsp) {\n\t\t\t\treturn callback && callback(err, rsp);\n\t\t\t});\n\t\t});\n\t}\n\n\tcount(model, callback, where) {\n\t\tdebug('CouchDB count');\n\t\treturn this.all(model, {where}, (err, docs) => {\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\treturn callback && callback(null, docs.length);\n\t\t});\n\t}\n\n\tall(model, filter, callback) {\n\t\tvar id;\n\t\tvar ref;\n\t\tvar where;\n\t\tdebug('CouchDB all');\n\t\tdebug(filter);\n\t\t// Consider first the easy case that a specific id is requested\n\t\tif (id = (((ref = ((typeof filter !== \"undefined\" && filter !== null) ? filter.where : undefined)) != null) ? ref.id : undefined)) {\n\t\t\tdebug('...moving to findById from all');\n\t\t\t// support include filter\n\t\t\tif ((typeof filter !== \"undefined\" && filter !== null) ? filter.include : undefined) {\n\t\t\t\treturn this.findById(model, id, (err, result) => {\n\t\t\t\t\tif (err) { return callback(err); }\n\t\t\t\t\treturn this._models[model].model.include(result, filter.include, callback);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\treturn this.findById(model, id, callback);\n\t\t\t}\n\t\t}\n\n\t\tvar params =\n\t\t\t{keys: [model],\n\t\t\tinclude_docs: true\n\t\t\t};\n\t\tif (filter.offset && !filter.where) { params.skip = filter.offset; }\n\t\tif (filter.limit && !filter.where) { params.limit = filter.limit; }\t\t//if you have a where clause and a limit first get all the data and then limit them\n\n\t\t// We always fallback on loopback/by_model view as it allows us\n\t\t// to iterate over all the docs for a model. But check if\n\t\t// there is a specialized view for one of the where conditions.\n\t\tvar designName = 'loopback';\n\t\tvar viewName = 'by_model';\n\t\tif (where = ((typeof filter !== \"undefined\" && filter !== null) ? filter.where : undefined)) {\n\t\t\tvar props = this._models[model].properties;\n\t\t\tfor (var propName in where) {\n\t\t\t\t// We can use an optimal view when a where \"clause\" uses an indexed property\n\t\t\t\tvar value = where[propName];\n\t\t\t\tif (value && (props[propName] != null) && props[propName].index) {\n\t\t\t\t\t// Use the design and view for the model and propName\n\t\t\t\t\tdesignName = helpers.designName(model);\n\t\t\t\t\tviewName = helpers.viewName(propName);\n\t\t\t\t\t// support loopback passing inq key arrays\n\t\t\t\t\tif ((value.inq != null)) {\n\t\t\t\t\t\tparams.keys = [];\n\t\t\t\t\t\tfor (var i = 0, key; i < value.inq.length; i++) {\n\t\t\t\t\t\t\tkey = value.inq[i];\n\t\t\t\t\t\t\tparams.keys.push(_.isDate(key) ? key.getTime() : key);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// CouchDb stores dates as Unix time\n\t\t\t\t\t\tparams.key = _.isDate(value) ? value.getTime() : value;\n\t\t\t\t\t\t// We don't want to use keys - we now have a key property\n\t\t\t\t\t\tdelete params.keys;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn this._nanoReader.view(designName, viewName, params, (err, body) => {\n\t\t\tvar orders;\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\tvar docs = (() => {\n\t\t\t\tvar result = [];\n\t\t\t\tfor (var j = 0, row; j < body.rows.length; j++) {\n\t\t\t\t\trow = body.rows[j];\n\t\t\t\t\trow.doc.id = row.doc._id;\n\t\t\t\t\tdelete row.doc._id;\n\t\t\t\t\tresult.push(row.doc);\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t})();\n\n\n\t\t\tdebug(\"CouchDB all: docs before where\");\n\t\t\tdebug(docs);\n\n\t\t\tif (where = ((typeof filter !== \"undefined\" && filter !== null) ? filter.where : undefined)) {\n\t\t\t\tdocs = _.select(docs, (doc) => {\n\t\t\t\t\tvar isMatch = true;\n\t\t\t\t\tfor (var k in where) {\n\t\t\t\t\t\t// CouchDb stores dates as Unix time\n\t\t\t\t\t\tvar v = where[k];\n\t\t\t\t\t\tif (_.isDate(v)) { where[k] = v.getTime(); }\n\t\t\t\t\t\t// support loopback inq queries\n\t\t\t\t\t\tif (where[k].inq) {\n\t\t\t\t\t\t\tif (!_.contains(where[k].inq, doc[k])) { isMatch = false; }\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif (doc[k] !== where[k]) { isMatch = false; }\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn isMatch;\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdebug(\"CouchDB all: docs after where\");\n\t\t\tdebug(docs);\n\n\t\t\tif (orders = ((typeof filter !== \"undefined\" && filter !== null) ? filter.order : undefined)) {\n\t\t\t\tif (_.isString(orders)) { orders = [orders]; }\n\t\t\t\tvar sorting = function(a, b) {\n\t\t\t\t\tvar iterable = this;\n\t\t\t\t\tfor (var i = 0, item; i < iterable.length; i++) {\n\t\t\t\t\t\titem = iterable[i];\n\t\t\t\t\t\tvar ak;\n\t\t\t\t\t\tvar bk;\n\t\t\t\t\t\tvar rev;\n\t\t\t\t\t\tak = a[this[i].key], bk = b[this[i].key], rev = this[i].reverse;\n\t\t\t\t\t\tif (ak > bk) { return 1 * rev; }\n\t\t\t\t\t\tif (ak < bk) { return -1 * rev; }\n\t\t\t\t\t}\n\t\t\t\t\treturn 0;\n\t\t\t\t};\n\n\t\t\t\tfor (var i = 0, key; i < orders.length; i++) {\n\t\t\t\t\tkey = orders[i];\n\t\t\t\t\torders[i] =\n\t\t\t\t\t\t{reverse: helpers.reverse(key),\n\t\t\t\t\t\tkey: helpers.stripOrder(key)\n\t\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tdocs.sort(sorting.bind(orders));\n\t\t\t}\n\n\t\t\tif (((typeof filter !== \"undefined\" && filter !== null) ? filter.limit : undefined) && ((typeof filter !== \"undefined\" && filter !== null) ? filter.where : undefined)) {\n\t\t\t\tvar maxDocsNum = filter.limit;\n\t\t\t} else {\n\t\t\t\tmaxDocsNum = docs.length;\n\t\t\t}\n\t\t\tif (((typeof filter !== \"undefined\" && filter !== null) ? filter.offset : undefined) && ((typeof filter !== \"undefined\" && filter !== null) ? filter.where : undefined)) {\n\t\t\t\tvar startDocsNum = filter.offset;\n\t\t\t} else {\n\t\t\t\tstartDocsNum = 0;\n\t\t\t}\n\n\t\t\tdocs = docs.slice(startDocsNum, maxDocsNum);\n\t\t\tvar output = ((() => {\n\t\t\t\tvar result = [];\n\t\t\t\tfor (var j = 0, doc; j < docs.length; j++) {\n\t\t\t\t\tdoc = docs[j];\n\t\t\t\t\tresult.push(this.fromDB(model, doc));\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t})());\n\n\t\t\t// support include filter\n\t\t\tif ((typeof filter !== \"undefined\" && filter !== null) ? filter.include : undefined) {\n\t\t\t\treturn this._models[model].model.include(output, filter.include, callback);\n\t\t\t} else {\n\t\t\t\treturn callback(null, output);\n\t\t\t}\n\t\t});\n\t}\n\n\n\tforDB(model, data = {}) {\n\t\thelpers.savePrep(model, data);\n\t\tvar props = this._models[model].properties;\n\t\tfor (var k in props) {\n\t\t\tvar v = props[k];\n\t\t\tif (data[k] && props[k].type.name === 'Date' && (data[k].getTime != null)) {\n\t\t\t\tdata[k] = data[k].getTime();\n\t\t\t}\n\t\t}\n\t\treturn data;\n\t}\n\n\tfromDB(model, data) {\n\t\tif (!data) { return data; }\n\t\thelpers.undoPrep(data);\n\t\tvar props = this._models[model].properties;\n\t\tfor (var k in props) {\n\t\t\tvar v = props[k];\n\t\t\tif ((data[k] != null) && props[k].type.name === 'Date') {\n\t\t\t\tvar date = new Date(data[k]);\n\t\t\t\tdate.setTime(data[k]);\n\t\t\t\tdata[k] = date;\n\t\t\t}\n\t\t}\n\t\treturn data;\n\t}\n\n\texists(model, id, callback) {\n\t\tdebug('CouchdDB exists');\n\t\treturn this._nanoReader.head(id, function(err, _, headers) {\n\t\t\tif (err) { return callback && callback(null, 0); }\n\t\t\treturn callback && callback(null, 1);\n\t\t});\n\t}\n\n\tgetLatestRevision(model, id, callback) {\n\t\treturn this._nanoReader.head(id, function(err, _, headers) {\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\tvar rev = headers.etag.substr(1, headers.etag.length - 2);\n\t\t\treturn callback && callback(null, rev);\n\t\t});\n\t}\n\n\tdestroy(model, id, callback) {\n\t\tdebug('CouchDB destroy');\n\t\treturn this.getLatestRevision(model, id, (err, rev) => {\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\treturn this._nanoWriter.destroy(id, rev, (err, rsp) => {\n\t\t\t\treturn callback && callback(err, rsp);\n\t\t\t});\n\t\t});\n\t}\n\n\tfindById(model, id, callback) {\n\t\tdebug('CouchDB findById');\n\t\treturn this._nanoReader.get(id, (err, doc) => {\n\t\t\tdebug(err, doc);\n\t\t\tif (err && err.statusCode === 404) { return callback && callback(null, []); }\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\treturn callback && callback(null, [(this.fromDB(model, doc))]);\t// Uses array as this function is called by all who needs to return array\n\t\t});\n\t}\n\n\tviewFunction(model, ddoc, viewname, keys, callback) {\n\t\tddoc = ddoc ? ddoc : this.settings.database || this.settings.db;\n\t\tvar view = _.findWhere(this._availableViews, {ddoc: ddoc, name: viewname});\n\n\t\tif (!view) {\n\t\t\treturn callback && callback(\"The requested view is not available in the datasource\");\n\t\t}\n\t\tvar params = keys;\n\t\tif (typeof keys === 'function') {\n\t\t\tcallback = keys;\n\t\t\tparams = {};\n\t\t}\n\t\tif (typeof keys === 'string') {\n\t\t\tparams = {keys: [keys]};\n\t\t}\n\t\tif (_.isArray(keys)) {\n\t\t\tparams = {keys: keys};\n\t\t}\n\n\n\t\tdebug(model, ddoc, viewname, params);\n\n\t\treturn this._nanoReader.view(ddoc, viewname, params, (err, rsp) => {\n\t\t\tif (err) { return callback && callback(err); }\n\t\t\tvar docs = _.pluck(rsp.rows, 'value');\n\t\t\treturn callback && callback(null, ((() => {\n\t\t\t\tvar result = [];\n\t\t\t\tfor (var i = 0, doc; i < docs.length; i++) {\n\t\t\t\t\tdoc = docs[i];\n\t\t\t\t\tresult.push(this.fromDB(model, doc));\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t})()));\n\t\t});\n\t}\n\n\tbuildViewEndpoint(views) {\n\t\tthis._availableViews = views;\n\t\tvar fn = _.bind(this.viewFunction, this);\n\t\tfn.accepts = [\n\t\t\t{\n\t\t\t\targ: 'modelName',\n\t\t\t\ttype: \"string\",\n\t\t\t\tdescription: \"The current model name\",\n\t\t\t\trequired: false,\n\t\t\t\thttp(ctx) {\n\t\t\t\t\treturn ctx.method.sharedClass.name;\n\t\t\t\t}\n\t\t\t},\n\t\t\t{ arg: 'ddoc', type: \"string\", description: \"The design document name for the requested view. Defaults to CouchDB database name used for this data.\", required: false, http: {source: 'query'}},\n\t\t\t{ arg: 'viewname', type: \"string\", description: \"The view name requested.\", required: true, http: {source: 'query'}},\n\t\t\t{ arg: 'keys', type: \"object\", description: \"The index(es) requested to narrow view results. Parameter can be a string, array of strings or object with 'key' or with 'startkey' and 'endkey', as per CouchDB. Use the object version for complex keys querying.\", required: false, http: {source: 'query'}}\n\t\t];\n\t\tfn.returns = { arg: 'items', type: \"array\"};\n\t\tfn.shared = true;\n\t\tfn.http =\n\t\t\t{path: '/queryView',\n\t\t\tverb: 'get'\n\t\t\t};\n\t\tfn.description = \"Query a CouchDB view based on design document name, view name and keys.\";\n\t\treturn fn;\n\t}\n\n\tbuildAuthUrl(auth) {\n\t\tif (auth && (auth.username || auth.user) && (auth.password || auth.pass)) {\n\t\t\tvar authString = (auth.username || auth.user) + ':' + (auth.password || auth.pass) + '@';\n\t\t} else {\n\t\t\tauthString = '';\n\t\t}\n\t\tvar url = this.settings.protocol + '://' + authString + this.settings.hostname + ':' + this.settings.port + '/' + this.settings.database;\n\t\treturn url;\n\t}\n}\n\n\n// helpers\nvar helpers =\n\t{optimizeSettings(settings) {\n\t\tsettings.hostname = settings.hostname || settings.host || '127.0.0.1';\n\t\tsettings.protocol = settings.protocol || 'http';\n\t\tsettings.port = settings.port || 5984;\n\t\tsettings.database = settings.database || settings.db;\n\t\tif (!settings.database) {\n\t\t\tthrow new Error(\"Database name must be specified in dataSource for CouchDB connector\");\n\t\t}\n\t},\n\n\tmerge(base, update) {\n\t\tif (!base) { return update; }\n\t\tif (!_.isArray(base)) {\n\t\t\t_.extend(base, update);\n\t\t} else {\n\t\t\t_.each(base, function(doc) {\n\t\t\t\treturn _.extend(doc, update);\n\t\t\t});\n\t\t}\n\t\treturn base;\n\t},\n\n\treverse(key) {\n\t\tvar hasOrder;\n\t\tif (hasOrder = key.match(/\\s+(A|DE)SC$/i)) {\n\t\t\tif (hasOrder[1] === \"DE\") { return -1; }\n\t\t}\n\t\treturn 1;\n\t},\n\n\tstripOrder(key) { return key.replace(/\\s+(A|DE)SC/i, \"\"); },\n\n\tsavePrep(model, data) {\n\t\tvar id;\n\t\tif (id = data.id) {\n\t\t\tdata._id = id.toString();\n\t\t}\n\t\tdelete data.id;\n\t\tif (data._rev === null) {\n\t\t\tdelete data._rev;\n\t\t}\n\t\tif (model) {\n\t\t\tdata.loopbackModel = model;\n\t\t}\n\t\treturn;\n\t},\n\n\tundoPrep(data) {\n\t\tvar _id;\n\t\tif (_id = data._id) {\n\t\t\tdata.id = _id.toString();\n\t\t}\n\t\tdelete data._id;\n\t\tdelete data.loopbackModel;\n\t\treturn;\n\t},\n\n\tdesignName(modelName) { return 'loopback_' + modelName; },\n\n\tviewName(propName) { return 'by_' + propName; },\n\n\tinvokeCallbackOrLogError(callback, err, res) {\n\t\t// When callback exists let it handle the error and result\n\t\tif (callback) {\n\t\t\treturn callback && callback(err, res);\n\t\t} else if (err) {\n\t\t\t// Without a callback we can at least log the error\n\t\t\treturn console.log(err);\n\t\t}\n\t},\n\n\tupdateDesign(db, designName, design, callback) {\n\t\t// Add the design document to the database or update it if it already exists.\n\t\treturn db.get(designName, (err, designDoc) => {\n\t\t\tif (err && err.error !== 'not_found') {\n\t\t\t\treturn helpers.invokeCallbackOrLogError(callback, err, designDoc);\n\t\t\t}\n\n\t\t\t// Update the design doc\n\t\t\tif (!designDoc) {\n\t\t\t\tdesignDoc = design;\n\t\t\t} else {\n\t\t\t\t// We only update the design when its views have changed - this avoids rebuilding the views.\n\t\t\t\tif (_.isEqual(designDoc.views, design.views)) {\n\t\t\t\t\treturn helpers.invokeCallbackOrLogError(callback, null, designDoc);\n\t\t\t\t}\n\t\t\t\tdesignDoc.views = design.views;\n\t\t\t}\n\n\t\t\t// Insert the design doc into the database.\n\t\t\treturn db.insert(designDoc, designName, (err, insertedDoc) => {\n\t\t\t\treturn helpers.invokeCallbackOrLogError(callback, err, insertedDoc);\n\t\t\t});\n\t\t});\n\t}\n\t};\n"],"sourceRoot":"/source/"}
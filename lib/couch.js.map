{"version":3,"sources":["couch.js"],"names":[],"mappings":";;;;;;eAAU,QAAQ,QAAR;;IAAL;;AACL,IAAI,QAAQ,QAAQ,OAAR,EAAiB,0BAAjB,CAAR;AACJ,IAAI,UAAU,QAAQ,cAAR,CAAV;;;AAGJ,QAAQ,UAAR,GAAqB,UAAS,UAAT,EAAqB,QAArB,EAA+B;AAClD,MAAI,YAAY,IAAI,cAAJ,CAAmB,UAAnB,CAAZ,CAD8C;AAElD,SAAO,YAAY,QAAQ,QAAR,CAAiB,QAAjB,CAAZ,CAF2C;CAA/B;;;;IAMf;AACJ,WADI,cACJ,CAAY,UAAZ,EAAwB;0BADpB,gBACoB;;AAEtB,QAAI,GAAJ,CAFsB;AAGtB,QAAI,IAAJ,CAHsB;AAItB,QAAI,IAAJ,CAJsB;AAKtB,SAAK,UAAL,GAAkB,KAAlB,CALsB;AAMtB,SAAK,UAAL,GAAkB,UAAlB,CANsB;AAOtB,eAAW,SAAX,GAAuB,IAAvB,CAPsB;;AAStB,QAAI,WAAW,WAAW,QAAX,IAAuB,EAAvB,CATO;AAUtB,SAAK,QAAL,GAAgB,QAAhB,CAVsB;AAWtB,YAAQ,gBAAR,CAAyB,QAAzB,EAXsB;;AAatB,QAAI,SAAS,EAAC,OACZ;AACE,kBAAU;AACR,eAAK,iFAAL;SADF;OAFU;KAAV,CAbkB;;AAqBtB,QAAI,CAAE,MAAM,SAAS,IAAT,CAAP,IAAyB,IAAzB,GAAiC,IAAI,MAAJ,GAAa,SAA/C,EAA0D;AAC5D,WAAK,WAAL,GAAmB,QAAQ,MAAR,EAAgB,KAAK,YAAL,CAAkB,SAAS,IAAT,CAAc,MAAd,CAAlC,CAAnB,CAD4D;KAA9D;AAGA,QAAI,CAAE,OAAO,SAAS,IAAT,CAAR,IAA0B,IAA1B,GAAkC,KAAK,MAAL,GAAc,SAAjD,EAA4D;AAC9D,WAAK,WAAL,GAAmB,QAAQ,MAAR,EAAgB,KAAK,YAAL,CAAkB,SAAS,IAAT,CAAc,MAAd,CAAlC,CAAnB,CAD8D;KAAhE;AAGA,QAAI,CAAE,OAAO,SAAS,IAAT,CAAR,IAA0B,IAA1B,GAAkC,KAAK,KAAL,GAAa,SAAhD,EAA2D;AAC7D,WAAK,UAAL,GAAkB,QAAQ,MAAR,EAAgB,KAAK,YAAL,CAAkB,SAAS,IAAT,CAAc,KAAd,CAAlC,CAAlB,CAD6D;KAA/D;;AAIA,QAAI,CAAC,KAAK,WAAL,EAAkB;AACrB,WAAK,WAAL,GAAmB,QAAQ,MAAR,EAAgB,KAAK,YAAL,CAAkB,SAAS,IAAT,CAAlC,CAAnB,CADqB;KAAvB;AAGA,QAAI,CAAC,KAAK,WAAL,EAAkB;AACrB,WAAK,WAAL,GAAmB,QAAQ,MAAR,EAAgB,KAAK,YAAL,CAAkB,SAAS,IAAT,CAAlC,CAAnB,CADqB;KAAvB;AAGA,QAAI,CAAC,KAAK,UAAL,EAAiB;AACpB,WAAK,UAAL,GAAkB,QAAQ,MAAR,EAAgB,KAAK,YAAL,CAAkB,SAAS,IAAT,CAAlC,CAAlB,CADoB;KAAtB;;AAIA,YAAQ,YAAR,CAAqB,KAAK,UAAL,EAAiB,kBAAtC,EAA0D,MAA1D,EAzCsB;AA0CtB,SAAK,OAAL,GAAe,EAAf,CA1CsB;AA2CtB,SAAK,IAAL,GAAY,SAAZ,CA3CsB;AA4CtB,QAAI,SAAS,KAAT,IAAkB,EAAE,OAAF,CAAU,SAAS,KAAT,CAA5B,EAA6C;AAC/C,WAAK,gBAAL,GAAwB,YAAW,EAAX;;AADuB,UAG3C,WAAW,WAAX,CAAuB,gBAAvB,EAAyC;AAC3C,aAAK,IAAI,CAAJ,IAAS,WAAW,WAAX,CAAuB,gBAAvB,EAAyC;AACrD,cAAI,IAAI,WAAW,WAAX,CAAuB,gBAAvB,CAAwC,CAAxC,CAAJ,CADiD;AAErD,eAAK,gBAAL,CAAsB,CAAtB,IAA2B,CAA3B,CAFqD;SAAvD;AAIA,aAAK,IAAI,CAAJ,IAAS,WAAW,WAAX,CAAuB,gBAAvB,CAAwC,SAAxC,EAAmD;AAC/D,cAAI,WAAW,WAAX,CAAuB,gBAAvB,CAAwC,SAAxC,CAAkD,CAAlD,CAAJ,CAD+D;AAE/D,eAAK,gBAAL,CAAsB,SAAtB,CAAgC,CAAhC,IAAqC,CAArC,CAF+D;SAAjE;OALF;;AAH+C,UAc3C,SAAS,KAAK,iBAAL,CAAuB,SAAS,KAAT,CAAhC,CAd2C;AAe/C,WAAK,gBAAL,CAAsB,SAAtB,GAAkC,MAAlC,CAf+C;AAgB/C,iBAAW,SAAX,GAAuB,MAAvB,CAhB+C;KAAjD;;AAmBA,WAAO,IAAP,CA/DsB;GAAxB;;eADI;;uCAmEe;AACjB,aAAO,MAAP,CADiB;;;;+BAIR;AACT,aAAO,CAAC,IAAD,EAAO,OAAP,EAAgB,SAAhB,CAAP,CADS;;;;kCAIG;AACZ,UAAI,CAAC,KAAK,SAAL,EAAgB;AACnB,aAAK,SAAL,GACE,EAAC,OAAO,KAAK,QAAL,EAAP;AACD,yBAAe,KAAK,gBAAL,EAAf;AACA,wBAAc,KAAK,UAAL;AACd,6BAAmB,EAAnB;SAJF,CADmB;OAArB;AAQA,aAAO,KAAK,SAAL,CATK;;;;2BAYP,OAAO;AACZ,UAAI,YAAY,MAAM,KAAN,CAAY,SAAZ,CADJ;;AAGZ,WAAK,OAAL,CAAa,SAAb,IAA0B,KAA1B,CAHY;AAIZ,YAAM,UAAN,CAAiB,IAAjB,GAAwB,EAAC,MAAM,MAAN,EAAzB;;AAJY,UAMR,SACF,EAAC,OAAO,EAAP,EADC,CANQ,IAQP,aAAa,KAAb,CARO;AASZ,WAAK,IAAI,QAAJ,IAAgB,MAAM,UAAN,EAAkB;AACrC,YAAI,QAAQ,MAAM,UAAN,CAAiB,QAAjB,CAAR,CADiC;AAErC,YAAI,MAAM,KAAN,EAAa;AACf,uBAAa,IAAb,CADe;AAEf,cAAI,WAAW,QAAQ,QAAR,CAAiB,QAAjB,CAAX,CAFW;AAGf,iBAAO,KAAP,CAAa,QAAb,IACA;AACE,iBAAK,kDAAkD,SAAlD,GAA8D,YAA9D,GAA2E,QAA3E,GAAsF,oBAAtF,GAA6G,QAA7G,GAAwH,YAAxH;WAFP,CAHe;SAAjB;OAFF;AAWA,OApBY,IAoBP,UAAJ,EAAgB;AACf,YAAI,aAAa,aAAa,QAAQ,UAAR,CAAmB,SAAnB,CAAb,CADF;AAEf,eAAO,QAAQ,YAAR,CAAqB,KAAK,UAAL,EAAiB,UAAtC,EAAkD,MAAlD,CAAP,CAFe;OAAhB;;;;;;;2BAOI,OAAO,MAAM,UAAU;AAC5B,YAAM,gBAAN,EAD4B;AAE5B,aAAO,KAAK,IAAL,CAAU,KAAV,EAAiB,IAAjB,EAAuB,QAAvB,CAAP,CAF4B;;;;yBAKzB,OAAO,MAAM,UAAU;AAC1B,YAAM,cAAN,EAD0B;AAE1B,UAAI,CAAC,IAAD,EAAO;AACT,eAAO,YAAY,SAAS,iDAAT,CAAZ,CADE;OAAX;AAGA,aAAO,KAAK,QAAL;AALmB,aAMnB,KAAK,WAAL,CAAiB,MAAjB,CAAwB,KAAK,KAAL,CAAW,KAAX,EAAkB,IAAlB,CAAxB,EAAiD,UAAC,GAAD,EAAM,GAAN,EAAc;AACpE,YAAI,GAAJ,EAAS;AACP,iBAAO,SAAS,GAAT,CAAP,CADO;SAAT;;;AADoE,eAMpE,CAAQ,QAAR,CAAiB,IAAjB;;AANoE,YAQpE,CAAK,IAAL,GAAY,IAAI,GAAJ,CARwD;AASpE,eAAO,YAAY,SAAS,IAAT,EAAe,IAAI,EAAJ,EAAQ,IAAI,GAAJ,CAAnC,CAT6D;OAAd,CAAxD,CAN0B;;;;mCAmBb,OAAO,MAAM,UAAU;AACpC,YAAM,wBAAN,EADoC;AAEpC,aAAO,KAAK,QAAL;AAF6B,aAG7B,KAAK,IAAL,CAAU,KAAV,EAAiB,IAAjB,EAAuB,UAAS,GAAT,EAAc,EAAd,EAAkB,GAAlB,EAAuB;AACnD,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,aAAK,EAAL,GAAU,EAAV,CAJmD;AAKnD,aAAK,IAAL,GAAY,GAAZ,CALmD;AAMnD,eAAO,YAAY,SAAS,IAAT,EAAe,IAAf,CAAZ,CAN4C;OAAvB,CAA9B,CAHoC;;;;2BAa/B,OAAO,OAAO,MAAM,UAAU;;;AACnC,YAAM,gBAAN,EADmC;AAEnC,aAAO,KAAK,QAAL;AAF4B,aAG5B,KAAK,GAAL,CAAS,KAAT,EAAgB,EAAC,YAAD,EAAhB,EAAyB,UAAC,GAAD,EAAM,UAAN,EAAqB;AACnD,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,gBAAQ,KAAR,CAAc,UAAd,EAA0B,IAA1B,EAJmD;AAKnD,YAAI,CAAC,EAAE,OAAF,CAAU,UAAV,CAAD,EAAwB;AAC1B,uBAAa,CAAC,UAAD,CAAb,CAD0B;SAA5B;AAGA,YAAI,OAAQ,YAAO;AACjB,cAAI,SAAS,EAAT,CADa;AAEjB,eAAK,IAAI,IAAI,CAAJ,EAAO,GAAX,EAAgB,IAAI,WAAW,MAAX,EAAmB,GAA5C,EAAiD;AAC/C,kBAAM,WAAW,CAAX,CAAN,CAD+C;AAE/C,mBAAO,IAAP,CAAY,MAAK,KAAL,CAAW,KAAX,EAAkB,GAAlB,CAAZ,EAF+C;WAAjD;AAIA,iBAAO,MAAP,CANiB;SAAN,EAAT,CAR+C;AAgBnD,cAAM,IAAN,EAhBmD;AAiBnD,eAAO,MAAK,WAAL,CAAiB,IAAjB,CAAsB,EAAC,UAAD,EAAtB,EAA8B,UAAS,GAAT,EAAc,GAAd,EAAmB;AACtD,iBAAO,YAAY,SAAS,GAAT,EAAc,GAAd,CAAZ,CAD+C;SAAnB,CAArC,CAjBmD;OAArB,CAAhC,CAHmC;;;;qCA0BpB,OAAO,IAAI,YAAY,UAAU;;;AAChD,YAAM,0BAAN,EADgD;AAEhD,aAAO,WAAW,QAAX;AAFyC,aAGzC,KAAK,WAAL,CAAiB,GAAjB,CAAqB,EAArB,EAAyB,UAAC,GAAD,EAAM,GAAN,EAAc;AAC5C,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,eAAO,OAAK,IAAL,CAAU,KAAV,EAAiB,QAAQ,KAAR,CAAc,GAAd,EAAmB,UAAnB,CAAjB,EAAiD,UAAS,GAAT,EAAc,GAAd,EAAmB;AACzE,cAAI,GAAJ,EAAS;AACP,mBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;WAAT;AAGA,cAAI,IAAJ,GAAW,IAAI,GAAJ,CAJ8D;AAKzE,iBAAO,YAAY,SAAS,IAAT,EAAe,GAAf,CAAZ,CALkE;SAAnB,CAAxD,CAJ4C;OAAd,CAAhC,CAHgD;;;;+BAiBvC,OAAO,OAAO,UAAU;;;AACjC,YAAM,oBAAN,EADiC;AAEjC,aAAO,KAAK,GAAL,CAAS,KAAT,EAAgB,EAAC,YAAD,EAAhB,EAAyB,UAAC,GAAD,EAAM,IAAN,EAAe;AAC7C,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,cAAM,IAAN,EAJ6C;AAK7C,eAAO,YAAO;AACZ,cAAI,SAAS,EAAT,CADQ;AAEZ,eAAK,IAAI,IAAI,CAAJ,EAAO,GAAX,EAAgB,IAAI,KAAK,MAAL,EAAa,GAAtC,EAA2C;AACzC,kBAAM,KAAK,CAAL,CAAN,CADyC;AAEzC,mBAAO,IAAP,CAAY,EAAC,KAAK,IAAI,EAAJ,EAAQ,MAAM,IAAI,IAAJ,EAAU,UAAU,IAAV,EAA1C,EAFyC;WAA3C;AAIA,iBAAO,MAAP,CANY;SAAN,EAAR,CAL6C;AAa7C,eAAO,OAAK,WAAL,CAAiB,IAAjB,CAAsB,EAAC,UAAD,EAAtB,EAA8B,UAAS,GAAT,EAAc,GAAd,EAAmB;AACtD,iBAAO,YAAY,SAAS,GAAT,EAAc,GAAd,CAAZ,CAD+C;SAAnB,CAArC,CAb6C;OAAf,CAAhC,CAFiC;;;;0BAqB7B,OAAO,UAAU,OAAO;AAC5B,YAAM,eAAN,EAD4B;AAE5B,aAAO,KAAK,GAAL,CAAS,KAAT,EAAgB,EAAC,YAAD,EAAhB,EAAyB,UAAC,GAAD,EAAM,IAAN,EAAe;AAC7C,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,eAAO,YAAY,SAAS,IAAT,EAAe,KAAK,MAAL,CAA3B,CAJsC;OAAf,CAAhC,CAF4B;;;;wBAU1B,OAAO,QAAQ,UAAU;;;AAC3B,UAAI,EAAJ,CAD2B;AAE3B,UAAI,GAAJ,CAF2B;AAG3B,UAAI,KAAJ,CAH2B;AAI3B,YAAM,aAAN,EAJ2B;AAK3B,YAAM,MAAN;;AAL2B,UAOvB,KAAM,CAAE,MAAO,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,KAAP,GAAe,SAApE,CAAR,IAA2F,IAA3F,GAAmG,IAAI,EAAJ,GAAS,SAA7G,EAAyH;AACjI,cAAM,gCAAN;;AADiI,YAG7H,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,OAAP,GAAiB,SAAtE,EAAiF;AACnF,iBAAO,KAAK,QAAL,CAAc,KAAd,EAAqB,EAArB,EAAyB,UAAC,GAAD,EAAM,MAAN,EAAiB;AAC/C,gBAAI,GAAJ,EAAS;AAAE,qBAAO,SAAS,GAAT,CAAP,CAAF;aAAT;AACA,mBAAO,OAAK,OAAL,CAAa,KAAb,EAAoB,KAApB,CAA0B,OAA1B,CAAkC,MAAlC,EAA0C,OAAO,OAAP,EAAgB,QAA1D,CAAP,CAF+C;WAAjB,CAAhC,CADmF;SAArF,MAKO;AACL,iBAAO,KAAK,QAAL,CAAc,KAAd,EAAqB,EAArB,EAAyB,QAAzB,CAAP,CADK;SALP;OAHF;;AAaA,UAAI,SACF,EAAC,MAAM,CAAC,KAAD,CAAN;AACD,sBAAc,IAAd;OAFE,CApBuB;AAwB3B,UAAI,OAAO,MAAP,IAAiB,CAAC,OAAO,KAAP,EAAc;AAClC,eAAO,IAAP,GAAc,OAAO,MAAP,CADoB;OAApC;;AAxB2B,UA4BvB,OAAO,KAAP,IAAgB,CAAC,OAAO,KAAP,EAAc;AACjC,eAAO,KAAP,GAAe,OAAO,KAAP,CADkB;OAAnC;;;;;AA5B2B,UAmCvB,aAAa,UAAb,CAnCuB;AAoC3B,UAAI,WAAW,UAAX,CApCuB;AAqC3B,UAAI,QAAS,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,KAAP,GAAe,SAApE,EAAgF;AAC3F,YAAI,QAAQ,KAAK,OAAL,CAAa,KAAb,EAAoB,UAApB,CAD+E;AAE3F,aAAK,IAAI,QAAJ,IAAgB,KAArB,EAA4B;;AAE1B,cAAI,QAAQ,MAAM,QAAN,CAAR,CAFsB;AAG1B,cAAI,SAAU,MAAM,QAAN,KAAmB,IAAnB,IAA4B,MAAM,QAAN,EAAgB,KAAhB,EAAuB;;AAE/D,yBAAa,QAAQ,UAAR,CAAmB,KAAnB,CAAb,CAF+D;AAG/D,uBAAW,QAAQ,QAAR,CAAiB,QAAjB,CAAX;;AAH+D,gBAK1D,MAAM,GAAN,IAAa,IAAb,EAAoB;AACvB,qBAAO,IAAP,GAAc,EAAd,CADuB;AAEvB,mBAAK,IAAI,IAAI,CAAJ,EAAO,GAAX,EAAgB,IAAI,MAAM,GAAN,CAAU,MAAV,EAAkB,GAA3C,EAAgD;AAC9C,sBAAM,MAAM,GAAN,CAAU,CAAV,CAAN,CAD8C;AAE9C,uBAAO,IAAP,CAAY,IAAZ,CAAiB,EAAE,MAAF,CAAS,GAAT,IAAgB,IAAI,OAAJ,EAAhB,GAAgC,GAAhC,CAAjB,CAF8C;eAAhD;aAFF,MAMO;;AAEL,qBAAO,GAAP,GAAa,EAAE,MAAF,CAAS,KAAT,IAAkB,MAAM,OAAN,EAAlB,GAAoC,KAApC;;AAFR,qBAIE,OAAO,IAAP,CAJF;aANP;AAYA,kBAjB+D;WAAjE;SAHF;OAFF;;AA2BA,aAAO,KAAK,WAAL,CAAiB,IAAjB,CAAsB,UAAtB,EAAkC,QAAlC,EAA4C,MAA5C,EAAoD,UAAC,GAAD,EAAM,IAAN,EAAe;AACxE,YAAI,MAAJ,CADwE;AAExE,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,YAAI,OAAO,YAAO;AAChB,cAAI,SAAS,EAAT,CADY;AAEhB,eAAK,IAAI,IAAI,CAAJ,EAAO,GAAX,EAAgB,IAAI,KAAK,IAAL,CAAU,MAAV,EAAkB,GAA3C,EAAgD;AAC9C,kBAAM,KAAK,IAAL,CAAU,CAAV,CAAN,CAD8C;AAE9C,gBAAI,GAAJ,CAAQ,EAAR,GAAa,IAAI,GAAJ,CAAQ,GAAR,CAFiC;AAG9C,mBAAO,IAAI,GAAJ,CAAQ,GAAR,CAHuC;AAI9C,mBAAO,IAAP,CAAY,IAAI,GAAJ,CAAZ,CAJ8C;WAAhD;AAMA,iBAAO,MAAP,CARgB;SAAN,EAAR,CALoE;;AAiBxE,cAAM,gCAAN,EAjBwE;AAkBxE,cAAM,IAAN,EAlBwE;;AAoBxE,YAAI,QAAS,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,KAAP,GAAe,SAApE,EAAgF;AAC3F,iBAAO,EAAE,MAAF,CAAS,IAAT,EAAe,UAAC,GAAD,EAAS;AAC7B,gBAAI,UAAU,IAAV,CADyB;AAE7B,iBAAK,IAAI,CAAJ,IAAS,KAAd,EAAqB;;AAEnB,kBAAI,IAAI,MAAM,CAAN,CAAJ,CAFe;AAGnB,kBAAI,EAAE,MAAF,CAAS,CAAT,CAAJ,EAAiB;AACf,sBAAM,CAAN,IAAW,EAAE,OAAF,EAAX,CADe;eAAjB;;AAHmB,kBAOf,MAAM,CAAN,EAAS,GAAT,EAAc;AAChB,oBAAI,CAAC,EAAE,QAAF,CAAW,MAAM,CAAN,EAAS,GAAT,EAAc,IAAI,CAAJ,CAAzB,CAAD,EAAmC;AACrC,4BAAU,KAAV,CADqC;iBAAvC;eADF,MAIO;AACL,oBAAI,IAAI,CAAJ,MAAW,MAAM,CAAN,CAAX,EAAqB;AACvB,4BAAU,KAAV,CADuB;iBAAzB;eALF;aAPF;AAiBA,mBAAO,OAAP,CAnB6B;WAAT,CAAtB,CAD2F;SAA7F;;AAwBA,cAAM,+BAAN,EA5CwE;AA6CxE,cAAM,IAAN,EA7CwE;;AA+CxE,YAAI,SAAU,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,KAAP,GAAe,SAApE,EAAgF;AAC5F,cAAI,EAAE,QAAF,CAAW,MAAX,CAAJ,EAAwB;AAAE,qBAAS,CAAC,MAAD,CAAT,CAAF;WAAxB;AACA,cAAI,UAAU,SAAV,OAAU,CAAS,CAAT,EAAY,CAAZ,EAAe;AAC3B,gBAAI,WAAW,IAAX,CADuB;AAE3B,iBAAK,IAAI,IAAI,CAAJ,EAAO,IAAX,EAAiB,IAAI,SAAS,MAAT,EAAiB,GAA3C,EAAgD;AAC9C,qBAAO,SAAS,CAAT,CAAP,CAD8C;AAE9C,kBAAI,EAAJ,CAF8C;AAG9C,kBAAI,EAAJ,CAH8C;AAI9C,kBAAI,GAAJ,CAJ8C;AAK9C,mBAAK,EAAE,KAAK,CAAL,EAAQ,GAAR,CAAP,EAAqB,KAAK,EAAE,KAAK,CAAL,EAAQ,GAAR,CAAP,EAAqB,MAAM,KAAK,CAAL,EAAQ,OAAR,CALF;AAM9C,kBAAI,KAAK,EAAL,EAAS;AACX,uBAAO,IAAI,GAAJ,CADI;eAAb;AAGA,kBAAI,KAAK,EAAL,EAAS;AACX,uBAAO,CAAC,CAAD,GAAK,GAAL,CADI;eAAb;aATF;AAaA,mBAAO,CAAP,CAf2B;WAAf,CAF8E;;AAoB5F,eAAK,IAAI,IAAI,CAAJ,EAAO,GAAX,EAAgB,IAAI,OAAO,MAAP,EAAe,GAAxC,EAA6C;AAC3C,kBAAM,OAAO,CAAP,CAAN,CAD2C;AAE3C,mBAAO,CAAP,IACE,EAAC,SAAS,QAAQ,OAAR,CAAgB,GAAhB,CAAT;AACD,mBAAK,QAAQ,UAAR,CAAmB,GAAnB,CAAL;aAFF,CAF2C;WAA7C;;AAQA,eAAK,IAAL,CAAU,QAAQ,IAAR,CAAa,MAAb,CAAV,EA5B4F;SAA9F;;AA+BA,YAAI,CAAC,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,KAAP,GAAe,SAApE,CAAD,KAAoF,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,KAAP,GAAe,SAApE,CAApF,EAAoK;AACtK,cAAI,aAAa,OAAO,KAAP,CADqJ;SAAxK,MAEO;AACL,uBAAa,KAAK,MAAL,CADR;SAFP;AAKA,YAAI,CAAC,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,MAAP,GAAgB,SAArE,CAAD,KAAqF,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,KAAP,GAAe,SAApE,CAArF,EAAqK;AACvK,cAAI,eAAe,OAAO,MAAP,CADoJ;SAAzK,MAEO;AACL,yBAAe,CAAf,CADK;SAFP;;AAMA,eAAO,KAAK,KAAL,CAAW,YAAX,EAAyB,UAAzB,CAAP,CAzFwE;AA0FxE,YAAI,SAAU,YAAO;AACnB,cAAI,SAAS,EAAT,CADe;AAEnB,eAAK,IAAI,IAAI,CAAJ,EAAO,GAAX,EAAgB,IAAI,KAAK,MAAL,EAAa,GAAtC,EAA2C;AACzC,kBAAM,KAAK,CAAL,CAAN,CADyC;AAEzC,mBAAO,IAAP,CAAY,OAAK,MAAL,CAAY,KAAZ,EAAmB,GAAnB,CAAZ,EAFyC;WAA3C;AAIA,iBAAO,MAAP,CANmB;SAAN,EAAX;;;AA1FoE,YAoGpE,OAAQ,MAAP,KAAkB,WAAlB,IAAiC,WAAW,IAAX,GAAmB,OAAO,OAAP,GAAiB,SAAtE,EAAiF;AACnF,iBAAO,OAAK,OAAL,CAAa,KAAb,EAAoB,KAApB,CAA0B,OAA1B,CAAkC,MAAlC,EAA0C,OAAO,OAAP,EAAgB,QAA1D,CAAP,CADmF;SAArF,MAEO;AACL,iBAAO,SAAS,IAAT,EAAe,MAAf,CAAP,CADK;SAFP;OApGyD,CAA3D,CAhE2B;;;;0BA6KvB,OAAkB;UAAX,6DAAO,kBAAI;;AACtB,cAAQ,QAAR,CAAiB,KAAjB,EAAwB,IAAxB,EADsB;AAEtB,UAAI,QAAQ,KAAK,OAAL,CAAa,KAAb,EAAoB,UAApB,CAFU;AAGtB,WAAK,IAAI,CAAJ,IAAS,KAAd,EAAqB;AACnB,YAAI,IAAI,MAAM,CAAN,CAAJ,CADe;AAEnB,YAAI,KAAK,CAAL,KAAW,MAAM,CAAN,EAAS,IAAT,CAAc,IAAd,KAAuB,MAAvB,IAAkC,KAAK,CAAL,EAAQ,OAAR,IAAmB,IAAnB,EAA0B;AACzE,eAAK,CAAL,IAAU,KAAK,CAAL,EAAQ,OAAR,EAAV,CADyE;SAA3E;OAFF;AAMA,aAAO,IAAP,CATsB;;;;2BAYjB,OAAO,MAAM;AAClB,UAAI,CAAC,IAAD,EAAO;AACT,eAAO,IAAP,CADS;OAAX;AAGA,cAAQ,QAAR,CAAiB,IAAjB,EAJkB;AAKlB,UAAI,QAAQ,KAAK,OAAL,CAAa,KAAb,EAAoB,UAApB,CALM;AAMlB,WAAK,IAAI,CAAJ,IAAS,KAAd,EAAqB;AACnB,YAAI,IAAI,MAAM,CAAN,CAAJ,CADe;AAEnB,YAAI,IAAC,CAAK,CAAL,KAAW,IAAX,IAAoB,MAAM,CAAN,EAAS,IAAT,CAAc,IAAd,KAAuB,MAAvB,EAA+B;AACtD,cAAI,OAAO,IAAI,IAAJ,CAAS,KAAK,CAAL,CAAT,CAAP,CADkD;AAEtD,eAAK,OAAL,CAAa,KAAK,CAAL,CAAb,EAFsD;AAGtD,eAAK,CAAL,IAAU,IAAV,CAHsD;SAAxD;OAFF;AAQA,aAAO,IAAP,CAdkB;;;;2BAiBb,OAAO,IAAI,UAAU;AAC1B,YAAM,iBAAN,EAD0B;AAE1B,aAAO,KAAK,WAAL,CAAiB,IAAjB,CAAsB,EAAtB,EAA0B,UAAS,GAAT,EAAc,CAAd,EAAiB,OAAjB,EAA0B;AACzD,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,IAAT,EAAe,CAAf,CAAZ,CADA;SAAT;AAGA,eAAO,YAAY,SAAS,IAAT,EAAe,CAAf,CAAZ,CAJkD;OAA1B,CAAjC,CAF0B;;;;sCAUV,OAAO,IAAI,UAAU;AACrC,aAAO,KAAK,WAAL,CAAiB,IAAjB,CAAsB,EAAtB,EAA0B,UAAS,GAAT,EAAc,CAAd,EAAiB,OAAjB,EAA0B;AACzD,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,YAAI,MAAM,QAAQ,IAAR,CAAa,MAAb,CAAoB,CAApB,EAAuB,QAAQ,IAAR,CAAa,MAAb,GAAsB,CAAtB,CAA7B,CAJqD;AAKzD,eAAO,YAAY,SAAS,IAAT,EAAe,GAAf,CAAZ,CALkD;OAA1B,CAAjC,CADqC;;;;4BAU/B,OAAO,IAAI,UAAU;;;AAC3B,YAAM,iBAAN,EAD2B;AAE3B,aAAO,KAAK,iBAAL,CAAuB,KAAvB,EAA8B,EAA9B,EAAkC,UAAC,GAAD,EAAM,GAAN,EAAc;AACrD,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,eAAO,OAAK,WAAL,CAAiB,OAAjB,CAAyB,EAAzB,EAA6B,GAA7B,EAAkC,UAAC,GAAD,EAAM,GAAN,EAAc;AACrD,iBAAO,YAAY,SAAS,GAAT,EAAc,GAAd,CAAZ,CAD8C;SAAd,CAAzC,CAJqD;OAAd,CAAzC,CAF2B;;;;6BAYpB,OAAO,IAAI,UAAU;;;AAC5B,YAAM,kBAAN,EAD4B;AAE5B,aAAO,KAAK,WAAL,CAAiB,GAAjB,CAAqB,EAArB,EAAyB,UAAC,GAAD,EAAM,GAAN,EAAc;AAC5C,cAAM,GAAN,EAAW,GAAX,EAD4C;AAE5C,YAAI,OAAO,IAAI,UAAJ,KAAmB,GAAnB,EAAwB;AACjC,iBAAO,YAAY,SAAS,IAAT,EAAe,EAAf,CAAZ,CAD0B;SAAnC;AAGA,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,eAAO,YAAY,SAAS,IAAT,EAAe,CAAE,OAAK,MAAL,CAAY,KAAZ,EAAmB,GAAnB,CAAF,CAAf,CAAZ;AARqC,OAAd,CAAhC,CAF4B;;;;iCAcjB,OAAO,MAAM,UAAU,MAAM,UAAU;;;AAClD,aAAO,OAAO,IAAP,GAAc,KAAK,QAAL,CAAc,QAAd,IAA0B,KAAK,QAAL,CAAc,EAAd,CADG;AAElD,UAAI,OAAO,EAAE,SAAF,CAAY,KAAK,eAAL,EAAsB,EAAC,MAAM,IAAN,EAAY,MAAM,QAAN,EAA/C,CAAP,CAF8C;;AAIlD,UAAI,CAAC,IAAD,EAAO;AACT,eAAO,YAAY,SAAS,uDAAT,CAAZ,CADE;OAAX;AAGA,UAAI,SAAS,IAAT,CAP8C;AAQlD,UAAI,OAAO,IAAP,KAAgB,UAAhB,EAA4B;AAC9B,mBAAW,IAAX,CAD8B;AAE9B,iBAAS,EAAT,CAF8B;OAAhC;AAIA,UAAI,OAAO,IAAP,KAAgB,QAAhB,EAA0B;AAC5B,iBAAS,EAAC,MAAM,CAAC,IAAD,CAAN,EAAV,CAD4B;OAA9B;AAGA,UAAI,EAAE,OAAF,CAAU,IAAV,CAAJ,EAAqB;AACnB,iBAAS,EAAC,MAAM,IAAN,EAAV,CADmB;OAArB;;AAKA,YAAM,KAAN,EAAa,IAAb,EAAmB,QAAnB,EAA6B,MAA7B,EApBkD;;AAsBlD,aAAO,KAAK,WAAL,CAAiB,IAAjB,CAAsB,IAAtB,EAA4B,QAA5B,EAAsC,MAAtC,EAA8C,UAAC,GAAD,EAAM,GAAN,EAAc;AACjE,YAAI,GAAJ,EAAS;AACP,iBAAO,YAAY,SAAS,GAAT,CAAZ,CADA;SAAT;AAGA,YAAI,OAAO,EAAE,KAAF,CAAQ,IAAI,IAAJ,EAAU,OAAlB,CAAP,CAJ6D;AAKjE,eAAO,YAAY,SAAS,IAAT,EAAgB,YAAO;AACxC,cAAI,SAAS,EAAT,CADoC;AAExC,eAAK,IAAI,IAAI,CAAJ,EAAO,GAAX,EAAgB,IAAI,KAAK,MAAL,EAAa,GAAtC,EAA2C;AACzC,kBAAM,KAAK,CAAL,CAAN,CADyC;AAEzC,mBAAO,IAAP,CAAY,OAAK,MAAL,CAAY,KAAZ,EAAmB,GAAnB,CAAZ,EAFyC;WAA3C;AAIA,iBAAO,MAAP,CANwC;SAAN,EAAjB,CAAZ,CAL0D;OAAd,CAArD,CAtBkD;;;;sCAsClC,OAAO;AACvB,WAAK,eAAL,GAAuB,KAAvB,CADuB;AAEvB,UAAI,KAAK,EAAE,IAAF,CAAO,KAAK,YAAL,EAAmB,IAA1B,CAAL,CAFmB;AAGvB,SAAG,OAAH,GAAa,CACX;AACE,aAAK,WAAL;AACA,cAAM,QAAN;AACA,qBAAa,wBAAb;AACA,kBAAU,KAAV;AACA,4BAAK,KAAK;AACR,iBAAO,IAAI,MAAJ,CAAW,WAAX,CAAuB,IAAvB,CADC;SALZ;OADW,EAUX;AACE,aAAK,MAAL;AACA,cAAM,QAAN;AACA,qBAAa,wGAAb;AACA,kBAAU,KAAV;AACA,cAAM;AACJ,kBAAQ,OAAR;SADF;OAfS,EAmBX;AACE,aAAK,UAAL;AACA,cAAM,QAAN;AACA,qBAAa,0BAAb;AACA,kBAAU,IAAV;AACA,cAAM;AACJ,kBAAQ,OAAR;SADF;OAxBS,EA4BX;AACE,aAAK,MAAL;AACA,cAAM,QAAN;AACA,qBAAa,2NAAb;AACA,kBAAU,KAAV;AACA,cAAM;AACJ,kBAAQ,OAAR;SADF;OAjCS,CAAb,CAHuB;AAyCvB,SAAG,OAAH,GAAa;AACX,aAAK,OAAL;AACA,cAAM,OAAN;OAFF,CAzCuB;AA6CvB,SAAG,MAAH,GAAY,IAAZ,CA7CuB;AA8CvB,SAAG,IAAH,GACE,EAAC,MAAM,YAAN;AACD,cAAM,KAAN;OAFF,CA9CuB;AAkDvB,SAAG,WAAH,GAAiB,yEAAjB,CAlDuB;AAmDvB,aAAO,EAAP,CAnDuB;;;;iCAsDZ,MAAM;AACjB,UAAI,SAAS,KAAK,QAAL,IAAiB,KAAK,IAAL,CAA1B,KAAyC,KAAK,QAAL,IAAiB,KAAK,IAAL,CAA1D,EAAsE;AACxE,YAAI,aAAa,CAAC,KAAK,QAAL,IAAiB,KAAK,IAAL,CAAlB,GAA+B,GAA/B,IAAsC,KAAK,QAAL,IAAiB,KAAK,IAAL,CAAvD,GAAoE,GAApE,CADuD;OAA1E,MAEO;AACL,qBAAa,EAAb,CADK;OAFP;AAKA,UAAI,MAAM,KAAK,QAAL,CAAc,QAAd,GAAyB,KAAzB,GAAiC,UAAjC,GAA8C,KAAK,QAAL,CAAc,QAAd,GAAyB,GAAvE,GAA6E,KAAK,QAAL,CAAc,IAAd,GAAqB,GAAlG,GAAwG,KAAK,QAAL,CAAc,QAAd,CANjG;AAOjB,aAAO,GAAP,CAPiB;;;;SArjBf","file":"couch.js","sourcesContent":["var {_} = require('lodash');\nvar debug = require('debug')('loopback:connector:couch');\nvar helpers = require('./helpers.js');\n\n// api\nexports.initialize = function(dataSource, callback) {\n  var connector = new CouchConnector(dataSource);\n  return callback && process.nextTick(callback);\n};\n\n//Constructor and useful reference functions\nclass CouchConnector {\n  constructor(dataSource) {\n\n    var ref;\n    var ref1;\n    var ref2;\n    this.relational = false;\n    this.dataSource = dataSource;\n    dataSource.connector = this;\n\n    var settings = dataSource.settings || {};\n    this.settings = settings;\n    helpers.optimizeSettings(settings);\n\n    var design = {views:\n      {\n        by_model: {\n          map: 'function (doc) { if (doc.loopbackModel) return emit(doc.loopbackModel, null); }'\n        }\n      }\n    };\n\n    if (((ref = settings.auth) != null) ? ref.reader : undefined) {\n      this._nanoReader = require('nano')(this.buildAuthUrl(settings.auth.reader));\n    }\n    if (((ref1 = settings.auth) != null) ? ref1.writer : undefined) {\n      this._nanoWriter = require('nano')(this.buildAuthUrl(settings.auth.writer));\n    }\n    if (((ref2 = settings.auth) != null) ? ref2.admin : undefined) {\n      this._nanoAdmin = require('nano')(this.buildAuthUrl(settings.auth.admin));\n    }\n\n    if (!this._nanoReader) {\n      this._nanoReader = require('nano')(this.buildAuthUrl(settings.auth));\n    }\n    if (!this._nanoWriter) {\n      this._nanoWriter = require('nano')(this.buildAuthUrl(settings.auth));\n    }\n    if (!this._nanoAdmin) {\n      this._nanoAdmin = require('nano')(this.buildAuthUrl(settings.auth));\n    }\n\n    helpers.updateDesign(this._nanoAdmin, '_design/loopback', design);\n    this._models = {};\n    this.name = 'couchdb';\n    if (settings.views && _.isArray(settings.views)) {\n      this.DataAccessObject = function() {};\n      //add existing methods\n      if (dataSource.constructor.DataAccessObject) {\n        for (var k in dataSource.constructor.DataAccessObject) {\n          var v = dataSource.constructor.DataAccessObject[k];\n          this.DataAccessObject[k] = v;\n        }\n        for (var k in dataSource.constructor.DataAccessObject.prototype) {\n          v = dataSource.constructor.DataAccessObject.prototype[k];\n          this.DataAccessObject.prototype[k] = v;\n        }\n      }\n      //then add connector method\n      var viewFn = this.buildViewEndpoint(settings.views);\n      this.DataAccessObject.queryView = viewFn;\n      dataSource.queryView = viewFn;\n    }\n\n    return this;\n  }\n\n  getDefaultIdType() {\n    return String;\n  }\n\n  getTypes() {\n    return ['db', 'nosql', 'couchdb'];\n  }\n\n  getMetadata() {\n    if (!this._metaData) {\n      this._metaData =\n        {types: this.getTypes(),\n        defaultIdType: this.getDefaultIdType(),\n        isRelational: this.relational,\n        schemaForSettings: {}\n        };\n    }\n    return this._metaData;\n  }\n\n  define(descr) {\n    var modelName = descr.model.modelName;\n\n    this._models[modelName] = descr;\n    descr.properties._rev = {type: String};\n    // Add index views for schemas that have indexes\n    var design =\n      {views: {}}\n    ;var hasIndexes = false;\n    for (var propName in descr.properties) {\n      var value = descr.properties[propName];\n      if (value.index) {\n        hasIndexes = true;\n        var viewName = helpers.viewName(propName);\n        design.views[viewName] =\n        {\n          map: 'function (doc) { if (doc.loopbackModel === \\'' + modelName + '\\' && doc.'+propName + ') return emit(doc.' + propName + ', null); }'\n        };\n      }\n    }\n    ;if (hasIndexes) {\n      var designName = '_design/' + helpers.designName(modelName);\n      return helpers.updateDesign(this._nanoAdmin, designName, design);\n    }\n  }\n\n//Loopback.io prototype functions\n  create(model, data, callback) {\n    debug('CouchDB create');\n    return this.save(model, data, callback);\n  }\n\n  save(model, data, callback) {\n    debug('CouchDB save');\n    if (!data) {\n      return callback && callback('Cannot create an empty document in the database');\n    }\n    delete data._deleted;     // Prevents accidental deletion via save command\n    return this._nanoWriter.insert(this.forDB(model, data), (err, rsp) => {\n      if (err) {\n        return callback(err);\n      }\n      // Undo the effects of savePrep as data object is the only one\n      // that the Loopback.io can access.\n      helpers.undoPrep(data);\n      // Update the data object with the revision returned by CouchDb.\n      data._rev = rsp.rev;\n      return callback && callback(null, rsp.id, rsp.rev);\n    });\n  }\n\n  updateOrCreate(model, data, callback) {\n    debug('CouchDB updateOrCreate');\n    delete data._deleted;    // Prevents accidental deletion\n    return this.save(model, data, function(err, id, rev) {\n      if (err) {\n        return callback && callback(err);\n      }\n      data.id = id;\n      data._rev = rev;\n      return callback && callback(null, data);\n    });\n  }\n\n  update(model, where, data, callback) {\n    debug('CouchDB update');\n    delete data._deleted;    // Prevents accidental deletion\n    return this.all(model, {where}, (err, docsFromDb) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      helpers.merge(docsFromDb, data);\n      if (!_.isArray(docsFromDb)) {\n        docsFromDb = [docsFromDb];\n      }\n      var docs = ((() => {\n        var result = [];\n        for (var i = 0, doc; i < docsFromDb.length; i++) {\n          doc = docsFromDb[i];\n          result.push(this.forDB(model, doc));\n        }\n        return result;\n      })());\n      debug(docs);\n      return this._nanoWriter.bulk({docs}, function(err, rsp) {\n        return callback && callback(err, rsp);\n      });\n    });\n  }\n\n  updateAttributes(model, id, attributes, callback) {\n    debug('CouchDB updateAttributes');\n    delete attributes._deleted;  //prevent accidental deletion\n    return this._nanoReader.get(id, (err, doc) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      return this.save(model, helpers.merge(doc, attributes), function(err, rsp) {\n        if (err) {\n          return callback && callback(err);\n        }\n        doc._rev = rsp.rev;\n        return callback && callback(null, doc);\n      });\n    });\n  }\n\n  destroyAll(model, where, callback) {\n    debug('CouchDB destroyAll');\n    return this.all(model, {where}, (err, docs) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      debug(docs);\n      docs = (() => {\n        var result = [];\n        for (var i = 0, doc; i < docs.length; i++) {\n          doc = docs[i];\n          result.push({_id: doc.id, _rev: doc._rev, _deleted: true});\n        }\n        return result;\n      })();\n      return this._nanoWriter.bulk({docs}, function(err, rsp) {\n        return callback && callback(err, rsp);\n      });\n    });\n  }\n\n  count(model, callback, where) {\n    debug('CouchDB count');\n    return this.all(model, {where}, (err, docs) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      return callback && callback(null, docs.length);\n    });\n  }\n\n  all(model, filter, callback) {\n    var id;\n    var ref;\n    var where;\n    debug('CouchDB all');\n    debug(filter);\n    // Consider first the easy case that a specific id is requested\n    if (id = (((ref = ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) != null) ? ref.id : undefined)) {\n      debug('...moving to findById from all');\n      // support include filter\n      if ((typeof filter !== 'undefined' && filter !== null) ? filter.include : undefined) {\n        return this.findById(model, id, (err, result) => {\n          if (err) { return callback(err); }\n          return this._models[model].model.include(result, filter.include, callback);\n        });\n      } else {\n        return this.findById(model, id, callback);\n      }\n    }\n\n    var params =\n      {keys: [model],\n      include_docs: true\n      };\n    if (filter.offset && !filter.where) {\n      params.skip = filter.offset;\n    }\n    //if you have a where clause and a limit first get all the data and then limit them\n    if (filter.limit && !filter.where) {\n      params.limit = filter.limit;\n    }\n\n    // We always fallback on loopback/by_model view as it allows us\n    // to iterate over all the docs for a model. But check if\n    // there is a specialized view for one of the where conditions.\n    var designName = 'loopback';\n    var viewName = 'by_model';\n    if (where = ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) {\n      var props = this._models[model].properties;\n      for (var propName in where) {\n        // We can use an optimal view when a where \"clause\" uses an indexed property\n        var value = where[propName];\n        if (value && (props[propName] != null) && props[propName].index) {\n          // Use the design and view for the model and propName\n          designName = helpers.designName(model);\n          viewName = helpers.viewName(propName);\n          // support loopback passing inq key arrays\n          if ((value.inq != null)) {\n            params.keys = [];\n            for (var i = 0, key; i < value.inq.length; i++) {\n              key = value.inq[i];\n              params.keys.push(_.isDate(key) ? key.getTime() : key);\n            }\n          } else {\n            // CouchDb stores dates as Unix time\n            params.key = _.isDate(value) ? value.getTime() : value;\n            // We don't want to use keys - we now have a key property\n            delete params.keys;\n          }\n          break;\n        }\n      }\n    }\n\n    return this._nanoReader.view(designName, viewName, params, (err, body) => {\n      var orders;\n      if (err) {\n        return callback && callback(err);\n      }\n      var docs = (() => {\n        var result = [];\n        for (var j = 0, row; j < body.rows.length; j++) {\n          row = body.rows[j];\n          row.doc.id = row.doc._id;\n          delete row.doc._id;\n          result.push(row.doc);\n        }\n        return result;\n      })();\n\n\n      debug('CouchDB all: docs before where');\n      debug(docs);\n\n      if (where = ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) {\n        docs = _.filter(docs, (doc) => {\n          var isMatch = true;\n          for (var k in where) {\n            // CouchDb stores dates as Unix time\n            var v = where[k];\n            if (_.isDate(v)) {\n              where[k] = v.getTime();\n            }\n            // support loopback inq queries\n            if (where[k].inq) {\n              if (!_.contains(where[k].inq, doc[k])) {\n                isMatch = false;\n              }\n            } else {\n              if (doc[k] !== where[k]) {\n                isMatch = false;\n              }\n            }\n          }\n          return isMatch;\n        });\n      }\n\n      debug('CouchDB all: docs after where');\n      debug(docs);\n\n      if (orders = ((typeof filter !== 'undefined' && filter !== null) ? filter.order : undefined)) {\n        if (_.isString(orders)) { orders = [orders]; }\n        var sorting = function(a, b) {\n          var iterable = this;\n          for (var i = 0, item; i < iterable.length; i++) {\n            item = iterable[i];\n            var ak;\n            var bk;\n            var rev;\n            ak = a[this[i].key], bk = b[this[i].key], rev = this[i].reverse;\n            if (ak > bk) {\n              return 1 * rev;\n            }\n            if (ak < bk) {\n              return -1 * rev;\n            }\n          }\n          return 0;\n        };\n\n        for (var i = 0, key; i < orders.length; i++) {\n          key = orders[i];\n          orders[i] =\n            {reverse: helpers.reverse(key),\n            key: helpers.stripOrder(key)\n            };\n        }\n\n        docs.sort(sorting.bind(orders));\n      }\n\n      if (((typeof filter !== 'undefined' && filter !== null) ? filter.limit : undefined) && ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) {\n        var maxDocsNum = filter.limit;\n      } else {\n        maxDocsNum = docs.length;\n      }\n      if (((typeof filter !== 'undefined' && filter !== null) ? filter.offset : undefined) && ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) {\n        var startDocsNum = filter.offset;\n      } else {\n        startDocsNum = 0;\n      }\n\n      docs = docs.slice(startDocsNum, maxDocsNum);\n      var output = ((() => {\n        var result = [];\n        for (var j = 0, doc; j < docs.length; j++) {\n          doc = docs[j];\n          result.push(this.fromDB(model, doc));\n        }\n        return result;\n      })());\n\n      // support include filter\n      if ((typeof filter !== 'undefined' && filter !== null) ? filter.include : undefined) {\n        return this._models[model].model.include(output, filter.include, callback);\n      } else {\n        return callback(null, output);\n      }\n    });\n  }\n\n\n  forDB(model, data = {}) {\n    helpers.savePrep(model, data);\n    var props = this._models[model].properties;\n    for (var k in props) {\n      var v = props[k];\n      if (data[k] && props[k].type.name === 'Date' && (data[k].getTime != null)) {\n        data[k] = data[k].getTime();\n      }\n    }\n    return data;\n  }\n\n  fromDB(model, data) {\n    if (!data) {\n      return data;\n    }\n    helpers.undoPrep(data);\n    var props = this._models[model].properties;\n    for (var k in props) {\n      var v = props[k];\n      if ((data[k] != null) && props[k].type.name === 'Date') {\n        var date = new Date(data[k]);\n        date.setTime(data[k]);\n        data[k] = date;\n      }\n    }\n    return data;\n  }\n\n  exists(model, id, callback) {\n    debug('CouchdDB exists');\n    return this._nanoReader.head(id, function(err, _, headers) {\n      if (err) {\n        return callback && callback(null, 0);\n      }\n      return callback && callback(null, 1);\n    });\n  }\n\n  getLatestRevision(model, id, callback) {\n    return this._nanoReader.head(id, function(err, _, headers) {\n      if (err) {\n        return callback && callback(err);\n      }\n      var rev = headers.etag.substr(1, headers.etag.length - 2);\n      return callback && callback(null, rev);\n    });\n  }\n\n  destroy(model, id, callback) {\n    debug('CouchDB destroy');\n    return this.getLatestRevision(model, id, (err, rev) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      return this._nanoWriter.destroy(id, rev, (err, rsp) => {\n        return callback && callback(err, rsp);\n      });\n    });\n  }\n\n  findById(model, id, callback) {\n    debug('CouchDB findById');\n    return this._nanoReader.get(id, (err, doc) => {\n      debug(err, doc);\n      if (err && err.statusCode === 404) {\n        return callback && callback(null, []);\n      }\n      if (err) {\n        return callback && callback(err);\n      }\n      return callback && callback(null, [(this.fromDB(model, doc))]);  // Uses array as this function is called by all who needs to return array\n    });\n  }\n\n  viewFunction(model, ddoc, viewname, keys, callback) {\n    ddoc = ddoc ? ddoc : this.settings.database || this.settings.db;\n    var view = _.findWhere(this._availableViews, {ddoc: ddoc, name: viewname});\n\n    if (!view) {\n      return callback && callback('The requested view is not available in the datasource');\n    }\n    var params = keys;\n    if (typeof keys === 'function') {\n      callback = keys;\n      params = {};\n    }\n    if (typeof keys === 'string') {\n      params = {keys: [keys]};\n    }\n    if (_.isArray(keys)) {\n      params = {keys: keys};\n    }\n\n\n    debug(model, ddoc, viewname, params);\n\n    return this._nanoReader.view(ddoc, viewname, params, (err, rsp) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      var docs = _.pluck(rsp.rows, 'value');\n      return callback && callback(null, ((() => {\n        var result = [];\n        for (var i = 0, doc; i < docs.length; i++) {\n          doc = docs[i];\n          result.push(this.fromDB(model, doc));\n        }\n        return result;\n      })()));\n    });\n  }\n\n  buildViewEndpoint(views) {\n    this._availableViews = views;\n    var fn = _.bind(this.viewFunction, this);\n    fn.accepts = [\n      {\n        arg: 'modelName',\n        type: 'string',\n        description: 'The current model name',\n        required: false,\n        http(ctx) {\n          return ctx.method.sharedClass.name;\n        }\n      },\n      {\n        arg: 'ddoc',\n        type: 'string',\n        description: 'The design document name for the requested view. Defaults to CouchDB database name used for this data.',\n        required: false,\n        http: {\n          source: 'query'\n        }\n      },\n      {\n        arg: 'viewname',\n        type: 'string',\n        description: 'The view name requested.',\n        required: true,\n        http: {\n          source: 'query'\n        }\n      },\n      {\n        arg: 'keys',\n        type: 'object',\n        description: 'The index(es) requested to narrow view results. Parameter can be a string, array of strings or object with \\'key\\' or with \\'startkey\\' and \\'endkey\\', as per CouchDB. Use the object version for complex keys querying.',\n        required: false,\n        http: {\n          source: 'query'\n        }\n      }\n    ];\n    fn.returns = {\n      arg: 'items',\n      type: 'array'\n    };\n    fn.shared = true;\n    fn.http =\n      {path: '/queryView',\n      verb: 'get'\n      };\n    fn.description = 'Query a CouchDB view based on design document name, view name and keys.';\n    return fn;\n  }\n\n  buildAuthUrl(auth) {\n    if (auth && (auth.username || auth.user) && (auth.password || auth.pass)) {\n      var authString = (auth.username || auth.user) + ':' + (auth.password || auth.pass) + '@';\n    } else {\n      authString = '';\n    }\n    var url = this.settings.protocol + '://' + authString + this.settings.hostname + ':' + this.settings.port + '/' + this.settings.database;\n    return url;\n  }\n}\n"],"sourceRoot":"/source/"}